
&НаКлиенте
Процедура СформироватьШк(Команда)
	
	СформироватьШкСервер();
	
КонецПроцедуры

&НаСервере
Процедура СформироватьШкСервер()
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	_ВидыХранимыхФайлов.ТипДанныхОбъекта,
	|	_ВидыХранимыхФайлов.Метаданные
	|ИЗ
	|	Справочник._ВидыХранимыхФайлов КАК _ВидыХранимыхФайлов
	|
	|СГРУППИРОВАТЬ ПО
	|	_ВидыХранимыхФайлов.ТипДанныхОбъекта,
	|	_ВидыХранимыхФайлов.Метаданные";
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	Пока Выборка.Следующий() Цикл
		
		МетаданныеСтр    = Выборка.Метаданные;
		ТипДанныхОбъекта = Выборка.ТипДанныхОбъекта;
		
		Если Найти(МетаданныеСтр, "Документ") Тогда 
			Выборка1 = Документы[Выборка.ТипДанныхОбъекта].Выбрать(Дата("20130101"));
			Пока Выборка1.Следующий() Цикл 
				
				Запрос2 = Новый Запрос;
				Запрос2.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
				|	_НумераторДляШк.СквознойНомер КАК СквознойНомер
				|ИЗ
				|	РегистрСведений._НумераторДляШк КАК _НумераторДляШк
				|ГДЕ
				|	_НумераторДляШк.ЭлементСсылка = &ЭлементСсылка
				|
				|УПОРЯДОЧИТЬ ПО
				|	СквознойНомер УБЫВ";
				
				Запрос2.УстановитьПараметр("ЭлементСсылка", Выборка1.Ссылка);
				Результат2 = Запрос2.Выполнить();
				
				Если Результат2.Пустой() Тогда 
					
					Запрос3 = Новый Запрос;
					Запрос3.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
					|	_НумераторДляШк.СквознойНомер КАК СквознойНомер
					|ИЗ
					|	РегистрСведений._НумераторДляШк КАК _НумераторДляШк
					|
					|УПОРЯДОЧИТЬ ПО
					|	СквознойНомер УБЫВ";
					
					Результат3 = Запрос3.Выполнить();
					Если Результат3.Пустой() Тогда 
						Счетчик = 1;
					Иначе
						Счетчик = Запрос3.Выполнить().Выгрузить()[0].СквознойНомер + 1;
					КонецЕсли;
					
					НаборЗаписей = РегистрыСведений._НумераторДляШк.СоздатьНаборЗаписей();
					НаборЗаписей.Отбор.СквознойНомер.Установить(Счетчик);
					
					НоваяЗапись = НаборЗаписей.Добавить();
					
					НоваяЗапись.СквознойНомер = Счетчик;
					НоваяЗапись.ЭлементСсылка = Выборка1.Ссылка;
					НаборЗаписей.Записать();
					
				КонецЕсли;
				
			КонецЦикла;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры