
Процедура ОбновитьИзВнешнихДанных(КодОтбор = "") Экспорт
	
	МаксДлинаКодаКонст = Константы.МаксДлинаКодаНоменклатуры.Получить();
	Если МаксДлинаКодаКонст = 0 Тогда 
		МаксДлинаКода = 10;
	КонецЕсли;
	Конект = Новый ComОбъект("ADODB.Connection");
	СтрокаСоединения = "Driver={SQL Server};server=10.10.16.4;Uid=;Pwd=;DataBase = interchange_sap;";
	Конект.ConnectionString = СтрокаСоединения;
	Конект.Open();
	RecordSet = Новый ComОбъект("ADODB.Recordset");
	Recordset.CursorLocation = 3;
	Стр = "select * from interchange_sap.dbo.item_master";
	Если Не КодОтбор = "" Тогда 
		Стр = Стр + " WHERE (interchange_sap.dbo.item_master.IMPN = '" + КодОтбор + "')";
	КонецЕсли;
	Recordset.Open(Стр, Конект,2,3);
	НачатьТранзакцию();
	
	сч = 0;
	сч_транз = 0;
	Мас = Новый Массив;
	Пока Не Recordset.EOF() Цикл 
		сч = сч + 1;
		#Если Клиент Тогда
			Состояние("Обновление данных материалов " + Строка(сч));
		#КонецЕсли
		IMPN   = СокрЛП(Recordset.Fields("IMPN").Value);                                              //Код
		WERKS  = СокрЛП(Recordset.Fields("WERKS").Value);                                             //Завод
		IMRPPN = СокрЛП(Recordset.Fields("IMRPPN").Value);                                            //Замена 
		IMDSC  = _ОбработкаСтрок.УдалитьНедопустимыеСимволы(СокрЛП(Recordset.Fields("IMDSC").Value)); //Наим ориг
		ESDE   = _ОбработкаСтрок.УдалитьНедопустимыеСимволы(СокрЛП(Recordset.Fields("ESDE").Value));  //Наим англ 
		IMTIPM = СокрЛП(Recordset.Fields("IMTIPM").Value);                                            //Тип
		IMMODM = СокрЛП( Recordset.Fields("IMMODM").Value);                                           //Модель 
		IMPAR8 = СокрЛП(Recordset.Fields("IMPAR8").Value);                                            //Размерность 
		IMPAR8 = ?(IMPAR8 = "", "", IMMODM + IMPAR8);
		IMLSRN = СокрЛП(Recordset.Fields("IMLSRN").Value);                                            //Вести СН
		IMWHT  = Recordset.Fields("IMWHT").Value;                                                     //Вес 
		IMSTS  = Recordset.Fields("IMSTS").Value;                                                     //Статус 
		IMSTCK = Recordset.Fields("IMSTCK").Value;                                                    //Мин кол закупки
		IMOMUL = Recordset.Fields("IMOMUL").Value;                                                    //Кратность закупки 
		JJLIPR = Recordset.Fields("JJLIPR").Value;                                                    //Прайс
		IMNU   = Recordset.Fields("IMNU").Value;                                                      //Номер прайс листа
		
		КодПодготовленный = _УправлениеМастерДаннымиНоменклатуры.УдалитьНедопустимыеБуквыВКоде(IMPN);
		
		Если СтрДлина(IMPN) <= МаксДлинаКода Тогда 
			
			СтруктНов = Новый Структура("WERKS, IMPN, IMRPPN, IMDSC, ESDE, IMTIPM, IMMODM, IMPAR8, IMLSRN, IMWHT, IMSTS, IMSTCK, IMOMUL, JJLIPR, IMNU", WERKS, IMPN, IMRPPN, IMDSC, ESDE, IMTIPM, IMMODM, IMPAR8, IMLSRN, IMWHT, IMSTS, IMSTCK, IMOMUL, JJLIPR, IMNU);
			
			//Мастер данные
			Если Мас.Найти(КодПодготовленный) = Неопределено Тогда 
				Мас.Добавить(КодПодготовленный);
				КодЗаменаПодготовленный = _УправлениеМастерДаннымиНоменклатуры.УдалитьНедопустимыеБуквыВКоде(IMRPPN); 
				Поиск = Справочники._НоменклатураКорп.НайтиПоКоду(КодПодготовленный);
				Если Поиск.Пустая() Тогда 
					Объект = Справочники._НоменклатураКорп.СоздатьЭлемент();
					ЗаполнитьЗначенияСвойств(Объект,  СтруктНов);
					Объект.Код       = КодПодготовленный;
					Объект.ДатаОбнов = ТекущаяДата();
					Объект.Записать();
					Ссылка           = Объект.Ссылка;
				Иначе
					СтруктТек = Новый Структура("WERKS, IMPN, IMRPPN, IMDSC, ESDE, IMTIPM, IMMODM, IMPAR8, IMLSRN, IMWHT, IMSTS, IMSTCK, IMOMUL, JJLIPR, IMNU");
					ЗаполнитьЗначенияСвойств(СтруктТек,  Поиск);
					СериализЭлемТек = _Сериализация.СериализоватьОбъектXDTO(СтруктТек);
					СериализЭлемНов = _Сериализация.СериализоватьОбъектXDTO(СтруктНов);
					Если НЕ СериализЭлемТек = СериализЭлемНов Тогда 
						Объект = Поиск.ПолучитьОбъект();
						ЗаполнитьЗначенияСвойств(Объект, СтруктНов);
						Объект.ДатаОбнов = ТекущаяДата();
						Объект.Записать();
						Ссылка           = Объект.Ссылка;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			
			//Цены
			ЕстьИзмененияЦен = Ложь;
			СтрокаЦены = Ссылка.Цены.Найти(IMNU, "IMNU");
			Если СтрокаЦены = Неопределено Тогда 
				ЕстьИзмененияЦен = Истина;
			Иначе 
				Если Не СтрокаЦены.JJLIPR	= JJLIPR Тогда 
					ЕстьИзмененияЦен = Истина;
				КонецЕсли;
			КонецЕсли;
			Если ЕстьИзмененияЦен Тогда 
				О = Ссылка.ПолучитьОбъект();
				Если СтрокаЦены = Неопределено Тогда 
					СтрокаЦены = О.Цены.Добавить();
				Иначе
					СтрокаЦены = О.Цены.Найти(IMNU, "IMNU");
				КонецЕсли;
				СтрокаЦены.IMNU   = IMNU;
				СтрокаЦены.JJLIPR = JJLIPR;
				СтрокаЦены.ДатаОбнов = ТекущаяДата();
				О.Записать();
			КонецЕсли;
			
			сч_транз = сч_транз + 1;
			Если сч_транз = 10000 Тогда 
				сч_транз = 0;
				ЗафиксироватьТранзакцию();
				НачатьТранзакцию();
			КонецЕсли;
			
		КонецЕсли;
		
		Recordset.MoveNext();
	КонецЦикла;
	ЗафиксироватьТранзакцию();
	Recordset.Close();
	RecordSet = "";
	Конект.Close();
	
КонецПроцедуры