
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Параметры.Свойство("СерийныйНомер") Тогда 
		
		СерийныйНомер = Параметры.СерийныйНомер;
		
		Таб.Очистить();
		
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		|	ТоварыНаСкладахОстатки.Номенклатура,
		|	ТоварыНаСкладахОстатки.Склад,
		|	NULL КАК Контрагент,
		|	ЕСТЬNULL(ТоварыНаСкладахОстатки.КоличествоОстаток, 0) КАК Остаток,
		|	NULL КАК Продано,
		|	NULL КАК Документ
		|ИЗ
		|	РегистрНакопления.ТоварыНаСкладах.Остатки(, СерияНоменклатуры.Наименование = &Сн) КАК ТоварыНаСкладахОстатки
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ПродажиОбороты.Номенклатура,
		|	NULL,
		|	ПродажиОбороты.Контрагент,
		|	NULL,
		|	ЕСТЬNULL(ПродажиОбороты.КоличествоОборот, 0),
		|	ПродажиОбороты.ДокументПродажи
		|ИЗ
		|	РегистрНакопления.Продажи.Обороты(, , , СерийныйНомер.Код = &Сн) КАК ПродажиОбороты
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ ПЕРВЫЕ 1
		|	ТоварыНаСкладахОбороты.КоличествоПриход,
		|	ТоварыНаСкладахОбороты.Регистратор КАК Регистратор,
		|	ТоварыНаСкладахОбороты.Склад
		|ИЗ
		|	РегистрНакопления.ТоварыНаСкладах.Обороты(, , Регистратор, СерияНоменклатуры.Наименование = &Сн) КАК ТоварыНаСкладахОбороты
		|
		|УПОРЯДОЧИТЬ ПО
		|	Регистратор УБЫВ";
		
		Запрос.УстановитьПараметр("Сн", СокрЛП(СерийныйНомер));
		
		Результат = Запрос.ВыполнитьПакет();
		
		ВыборкаДокПередачи = Результат[1].Выбрать(); 
		
		ВыборкаСост = Результат[0].Выбрать();
		Пока ВыборкаСост.Следующий() Цикл 
			
			Новая = Таб.Добавить();
			ЗаполнитьЗначенияСвойств(Новая, ВыборкаСост);
			
			Если ЗначениеЗаполнено(Новая.Склад) Тогда 
				Если ВыборкаДокПередачи.НайтиСледующий(Новая.Склад, "Склад") Тогда 
					Новая.Документ = ВыборкаДокПередачи.Регистратор;
				КонецЕсли;
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция   ПоместитьВоВременноеХранилищеСервер(ТекСтрока)
	
	ТекДанные = Таб.НайтиПоИдентификатору(ТекСтрока);
	
	Структура = Новый Структура;
	Структура.Вставить("Номенклатура", ТекДанные.Номенклатура);
	Структура.Вставить("Склад", ТекДанные.Склад);
	Структура.Вставить("Контрагент", ТекДанные.Контрагент);
	Если ЗначениеЗаполнено(ТекДанные.Документ) Тогда 
		Структура.Вставить("ДокументНомер", ОбщегоНазначения.ПолучитьНомерНаПечать(ТекДанные.Документ));
		Структура.Вставить("ДокументДата", ТекДанные.Документ.Дата);
	Иначе
		Структура.Вставить("ДокументНомер", "");	
		Структура.Вставить("ДокументДата", '00010101');
	КонецЕсли;
	
	Если ТипЗнч(ТекДанные.Документ) = Тип("ДокументСсылка.РеализацияТоваровУслуг") Тогда 
		Структура.Вставить("Продана");
	КонецЕсли;
	
	Структура.Вставить("Документ", ТекДанные.Документ);
	
	Адрес = ПоместитьВоВременноеХранилище(Структура, Новый УникальныйИдентификатор);
	
	Возврат Адрес ;
	
КонецФункции

&НаКлиенте
Процедура ВыбратьСтроку(Команда)
	
	Адрес = ПоместитьВоВременноеХранилищеСервер(Элементы.Таб.ТекущаяСтрока);
	Закрыть(Адрес);
	
КонецПроцедуры
