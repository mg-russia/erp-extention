
&НаСервере
Функция   Печать(СсылкаНаОбъект) Экспорт
	
	ТабДок = Новый ТабличныйДокумент;
	Макет = Документы._ГарантийныйЗапрос.ПолучитьМакет("АктРекламация");
	
	ОблШапка  = Макет.ПолучитьОбласть("Шапка");
	ОблСтрока = Макет.ПолучитьОбласть("Строка");
	ОблПодвал = Макет.ПолучитьОбласть("Подвал");
	
	ОблШапка.Параметры.ЗаголовокДокумента = "Акт-рекламация №" + СокрЛП(СсылкаНаОбъект.Номер) + " от: " + Формат(СсылкаНаОбъект.Дата, "ДФ=dd.MM.yyyy");
	
	ОблШапка.Параметры.АдресПотребителя = СсылкаНаОбъект.Рекламация_Адрес;
	Если ЗначениеЗаполнено(СсылкаНаОбъект.Дилер) Тогда 
		ОблШапка.Параметры.НаименованиеПотребителя = СсылкаНаОбъект.Дилер.НаименованиеПолное;
	КонецЕсли;
	ОблШапка.Параметры.РекламацияСоставлена    = СсылкаНаОбъект.Рекламация_Составлена;
	ОблШапка.Параметры.ПредставиельСЦ          = СсылкаНаОбъект.Рекламация_ПредставительСЦ;
	ОблШапка.Параметры.ПредставительВладельца  = СсылкаНаОбъект.Рекламация_ПредставительВладельца;
	Если ЗначениеЗаполнено(СсылкаНаОбъект.МодельМашины) Тогда 
		ОблШапка.Параметры.МаркаТехники        = СсылкаНаОбъект.МодельМашины.Код + "  " + СсылкаНаОбъект.МодельМашины.Наименование;
	КонецЕсли;	
	ОблШапка.Параметры.Серийныйномер = СсылкаНаОбъект.СерийныйНомер; 
	ОблШапка.Параметры.ГодВыпуска    = СсылкаНаОбъект.ГодВыпуска;   
	
	ОблШапка.Параметры.ДатаОтгрузки = Формат(СсылкаНаОбъект.ДатаОтгрузки, "ДФ=dd.MM.yyyy");
	ОблШапка.Параметры.ДатаВвода    = Формат(СсылкаНаОбъект.ДатаОтгрузки, "ДФ=dd.MM.yyyy");
	ОблШапка.Параметры.ДатаПоломки  = Формат(СсылкаНаОбъект.ДатаПоломки, "ДФ=dd.MM.yyyy");
	
	ОблШапка.Параметры.Наработка                = СсылкаНаОбъект.Рекламация_ЧасовОтДатыВводаВЭксп;
	ОблШапка.Параметры.ПриРаботе                = СсылкаНаОбъект.Рекламация_ВидРаботы;
	ОблШапка.Параметры.ГСМ                      = СсылкаНаОбъект.Рекламация_ГСМ;
	ОблШапка.Параметры.ПоследнееТО              = СсылкаНаОбъект.Рекламация_ТОПоследнее;
	ОблШапка.Параметры.ДатаТО                   = СсылкаНаОбъект.Рекламация_ТоДата;
	ОблШапка.Параметры.НаработкаТО              = СсылкаНаОбъект.Рекламация_ТоНаработка;
	ОблШапка.Параметры.Неисправность            = СсылкаНаОбъект.НеисправностьОписание;
	ОблШапка.Параметры.НеисправностьПричина     = СсылкаНаОбъект.НеисправностьПричина;
	ОблШапка.Параметры.ТребуютсяРаботы          = СсылкаНаОбъект.Рекламация_Работы;
	ОблШапка.Параметры.ТребуетсяДопОбследование = СсылкаНаОбъект.Рекламация_ПровестиДопИсследование;
	
	ТабДок.Вывести(ОблШапка);
	
	Номер = 0;
	Для Каждого Строка Из СсылкаНаОбъект.Товары Цикл
		Попытка
			Номер = Номер + 1;
			ОблСтрока.Параметры.Номер        = Номер;
			ОблСтрока.Параметры.Код          = Строка.Номенклатура.Код;
			ОблСтрока.Параметры.Наименование = Строка.Номенклатура.Наименование + "/" + Строка.Номенклатура.НаименованиеПолное;
			ОблСтрока.Параметры.Количество   = Строка.Количество;
			ТабДок.Вывести(ОблСтрока);
		Исключение
		КонецПопытки;
	КонецЦикла;
	
	ОблПодвал.Параметры.МашВостДата       = СсылкаНаОбъект.Рекламация_МашинаВосстановленаДата;
	ОблПодвал.Параметры.МашВостСилами     = СсылкаНаОбъект.Рекламация_МашинаВосстановленаКем;
	ОблПодвал.Параметры.МашВостМетодом    = СсылкаНаОбъект.Рекламация_МашинаВосстановленаМетодом;
	ОблПодвал.Параметры.ОсобыеЗамечания   = СсылкаНаОбъект.Рекламация_Замечания;
	ОблПодвал.Параметры.Выводы            = СсылкаНаОбъект.Рекламация_Результат;
	
	ТабДок.Вывести(ОблПодвал);
	
	ТабДок.АвтоМасштаб         = Истина;
	ТабДок.ОтображатьЗаголовки = Истина;
	ТабДок.ОтображатьСетку     = Ложь;
	
	Возврат ТабДок;
	
КонецФункции

&НаСервере
Функция   ОтправитьДокументы(ПараметрКоманды) Экспорт
	
	ТабДок = Печать(ПараметрКоманды);	
	ИмяВремФайла = ПолучитьИмяВременногоФайла(".xls");
	ТабДок.Записать(ИмяВремФайла, ТипФайлаТабличногоДокумента.xls);
	
	Адрес = _Кирилл.ПолучитьАдресЭлектроннойПочтыПользователя(глЗначениеПеременной("глТекущийПользователь"));
	
	Если Не ПустаяСтрока(Адрес) Тогда 
		
		СтруктураПараметров  = Новый Структура;
		СтруктураПараметров.Вставить("Кому"     , Адрес);
		СтруктураПараметров.Вставить("Тема"     , "Акт-рекламация № " + ОбщегоНазначения.ПолучитьНомерНаПечать(ПараметрКоманды) + " от " + Формат(ПараметрКоманды.Дата, "ДФ=dd.MM.yyyy"));
		СтруктураПараметров.Вставить("Текст"    , "");
		СтруктураПараметров.Вставить("Вложение" , ИмяВремФайла);
		
		ОбщегоНазначения.ОтправитьПисьмо(СтруктураПараметров);
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Письмо отправлено на ваш электронный адрес: " + Адрес;
		Сообщение.Сообщить();
		
	Иначе
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Не задан электронный адрес пользователя. Отправка письма невозможна";
		Сообщение.Сообщить();
	КонецЕсли;
	
КонецФункции

&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	
	ОтправитьДокументы(ПараметрКоманды);
	
КонецПроцедуры

