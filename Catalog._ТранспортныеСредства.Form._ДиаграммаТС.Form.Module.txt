
&НаСервере
Функция   ПолучитьДанныеТабеляНаДату(Дата, ТС)

	Мас = Новый Массив;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	_Табель.Автомобиль
	|ИЗ
	|	РегистрСведений._Табель КАК _Табель
	|ГДЕ
	|	_Табель.Дата = &Дата
	|	И _Табель.Автомобиль = &ТС";
	
	Запрос.УстановитьПараметр("Дата", Дата); 
	Запрос.УстановитьПараметр("ТС", ТС);
	
	Возврат НЕ Запрос.Выполнить().Пустой();
	
КонецФункции // ПолучитьДанныеТабеляНаДату()

&НаСервере
Процедура ОбновитьДиаграммуСервер()

	// Установить заголовок диаграммы. 
	ДГ.ОбластьЗаголовка.Текст  = "Gantt сhart. Cars" + Символы.ПС + "Red: business trip, blue: office" ;
	ДГ.ОбластьЗаголовка.Шрифт  = Новый Шрифт("Arial", 7);
	ДГ.ОтображатьЛегенду       = Ложь;
	ДГ.ОтображатьЗаголовок     = Истина;
	Дг.ОбластьПостроения.Шрифт = Новый Шрифт("Arial", 7);
	//Дг.ОтображатьЛегенду       = Истина;
	Если Дг.ОбластьПостроения.ШкалаВремени.Элементы.Количество() = 1 Тогда 
		Дг.ОбластьПостроения.ШкалаВремени.Элементы[0].Единица = ТипЕдиницыШкалыВремени.Месяц;
		Нов = Дг.ОбластьПостроения.ШкалаВремени.Элементы.Добавить();
		Нов.Единица = ТипЕдиницыШкалыВремени.День;
	КонецЕсли;
	
	Дг.ОтображениеИнтервала = ОтображениеИнтервалаДиаграммыГанта.Плоский;
	
	Дг.Серии.Очистить();
	Дг.Точки.Очистить();
	
	// Интервал будем определять самостоятельно. 
	ДГ.АвтоОпределениеПолногоИнтервала = Ложь; 
	
	// Интервал - месяц 
	//ДГ.УстановитьПолныйИнтервал(НачалоМесяца(ТекущаяДата()), КонецМесяца(ТекущаяДата()));
	ДГ.УстановитьПолныйИнтервал(Период.ДатаНачала, Период.ДатаОкончания - 24*3600);
	
	Серия1 = ДГ.УстановитьСерию("Status");
	Серия1.Цвет = WebЦвета.Красный;

	
	//Серия1 = ДГ.УстановитьСерию("In business trip");
	//Серия1.Цвет = WebЦвета.Красный;
	
	//Серия2 = ДГ.УстановитьСерию("In office");
	//Серия2.Цвет = WebЦвета.Синий;
	
	//Серия3 = ДГ.УстановитьСерию("On tech. service");
	//Серия3.Цвет = WebЦвета.Синий;
	
	Выборка = Справочники._ТранспортныеСредства.Выбрать();
	Пока Выборка.Следующий() Цикл 
		
		Если Не Выборка.Модель.ЭтоАвтотранспорт Тогда Продолжить; КонецЕсли;
		
		ТекТочка = ДГ.УстановитьТочку(Выборка.Наименование);	
		
		ТекДата = Период.ДатаНачала;
		
		Пока ТекДата < Период.ДатаОкончания Цикл 
			
			НаВыезде = ПолучитьДанныеТабеляНаДату(ТекДата, Выборка.Ссылка);
			Если НаВыезде Тогда 
				Значение = ДГ.ПолучитьЗначение(ТекТочка, Серия1);
			Иначе
				Значение = ДГ.ПолучитьЗначение(ТекТочка, Серия1);
			КонецЕсли;
			
			Интервал = Значение.Добавить(); 
			Интервал.Текст  = ""; 
			Интервал.Начало = ТекДата; 
			Интервал.Конец  = ТекДата + 1*24*3600;
			Интервал.Текст  = "";
			
			Если НаВыезде Тогда 
				Интервал.Цвет = WebЦвета.Красный;
			Иначе
				Интервал.Цвет = WebЦвета.Синий;	
			КонецЕсли;
			
			ТекДата = ТекДата + 24*3600;
			
		КонецЦикла;
		
	КонецЦикла;
		
КонецПроцедуры // ОбновитьДиаграммуСервер()

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Автомасштаб = Истина;
	Период.Вариант = ВариантСтандартногоПериода.Месяц;
	ОбновитьДиаграммуСервер();
	
КонецПроцедуры

&НаСервере
Процедура СохранитьДГСервер()
	
	Карт = ДГ.ПолучитьКартинку(1000,300,ФорматКартинки.PNG);
	ПутьДиаграммы = "C:\Temp\Cars" + Формат(Период.ДатаНачала, "ДФ=dd.MM.yy") + "-" + Формат(Период.ДатаОкончания, "ДФ=dd.MM.yy") + ".png";
	Карт.Записать(ПутьДиаграммы);
	
	ОбщегоНазначения.ОтправитьПисьмо(Новый Структура("Кому, Тема, Вложение", "kefimov@maschio.ru", "Сars diagram", ПутьДиаграммы));
	
КонецПроцедуры

&НаКлиенте
Процедура СохранитьВФайл(Команда)
	
	СохранитьДГСервер();

КонецПроцедуры

&НаКлиенте
Процедура ПериодПриИзменении(Элемент)
	
	ОбновитьДиаграммуСервер();
	
КонецПроцедуры

&НаКлиенте
Процедура ПериодДатаНачалаПриИзменении(Элемент)
	
	ОбновитьДиаграммуСервер();
	
КонецПроцедуры

&НаКлиенте
Процедура ПериодДатаОкончанияПриИзменении(Элемент)
	
	ОбновитьДиаграммуСервер();
	
КонецПроцедуры

&НаКлиенте
Процедура АвтомасштабПриИзменении(Элемент)
	
	Если НЕ Автомасштаб Тогда 
		ДГ.ПоддержкаМасштаба = ПоддержкаМасштабаДиаграммыГанта.Авто;
	Иначе
		ДГ.ПоддержкаМасштаба = ПоддержкаМасштабаДиаграммыГанта.ВсеДанные;
	КонецЕсли;
		
КонецПроцедуры
