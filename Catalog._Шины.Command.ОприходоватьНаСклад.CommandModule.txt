

&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	
	Темп = 1;
	//ВвестиЧисло(Темп, "Введите остаток шины (значение от 0 до 1)", 2, 1); 
	
	ТемпДата = ТекущаяДата();
	ВвестиДату(ТемпДата, "Введите дату оприходования шин");
	
	Рез = ОприходоватьНаСкладСервер(ПараметрКоманды, Темп, ТемпДата);
	Если Рез.Свойство("Док") Тогда  
		Предупреждение("Создан докмент оприходования: " + Рез.Док);
	Иначе
		Предупреждение("Не удалось оприходовать шину на склад. Причина: " + Рез.Сообщение);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция   ОприходоватьНаСкладСервер(Шина, Остаток, Дата)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	_УстановленныеШиныСрезПоследних.ТС,
	|	_УстановленныеШиныСрезПоследних.МестоУстановки,
	|	_УстановленныеШиныСрезПоследних.Шина
	|ИЗ
	|	РегистрСведений._УстановленныеШины.СрезПоследних(, Шина = &Шина) КАК _УстановленныеШиныСрезПоследних
	|ГДЕ
	|	_УстановленныеШиныСрезПоследних.ТС = &ТС";
	
	Запрос.УстановитьПараметр("ТС", _Кирилл.ПолучитьЗначениеПараметра("ОсновнойСклад"));
	Запрос.УстановитьПараметр("Шина", Шина);
	
	Если Запрос.Выполнить().Пустой() Тогда 
		
		Док                  = Документы._РемонтныйЛист.СоздатьДокумент();
		Док.ВидРемонтаТС     = Перечисления._ВидРемонтаТС.ПереоборудованиеШин;
		Док.Ответственный    = глЗначениеПеременной("глТекущийПользователь");
		Док.Дата             = Дата;
		Док.ТС               = _Кирилл.ПолучитьЗначениеПараметра("ОсновнойСклад");
		Док.Комментарий      = "Оприходование шины на склад";
		
		Новая                = Док.Шины.Добавить();
		Новая.Количество     = Остаток;
		Новая.СобытиеСШиной  = Перечисления._СобытиеСШиной.Установлена;
		Новая.Шина           = Шина;
		Если Дата > '20140601' Тогда 
			Новая.ТС             = Док.ТС;
		КонецЕсли;
		
		Док.Записать(РежимЗаписиДокумента.Проведение);
		Возврат Новый Структура("Док", Строка(Док.Ссылка));
		
	Иначе
		
		Выборка = Запрос.Выполнить().Выбрать();
		Выборка.Следующий();
		
		Возврат Новый Структура("Сообщение", "Шина уже находится на: " + Строка(Выборка.Тс));
		
	КонецЕсли;
	
КонецФункции
