
&НаСервере
Функция   Печать(СсылкаНаОбъект) Экспорт
	
	ТабДок = Новый ТабличныйДокумент;
	Макет = Документы._ГарантийныйЗапрос.ПолучитьМакет("ГарантийныйЗапрос");
	
	ОблШапка  = Макет.ПолучитьОбласть("Шапка");
	ОблСтрока = Макет.ПолучитьОбласть("Строка");
	ОблПодвал = Макет.ПолучитьОбласть("Подвал");
	
	ОблШапка.Параметры.Номер           = СокрЛП(СсылкаНаОбъект.Номер);
	ОблШапка.Параметры.Дата            = Формат(СсылкаНаОбъект.Дата, "ДФ=dd.MM.yyyy");
	Если ЗначениеЗаполнено(СсылкаНаОбъект.Дилер) Тогда 
		ОблШапка.Параметры.Дилер       = ОбщегоНазначения.ЗаменитьНаТранслит(СсылкаНаОбъект.Дилер.НаименованиеПолное);
	КонецЕсли;
	ОблШапка.Параметры.Модель          = СсылкаНаОбъект.МодельМашины;
	ОблШапка.Параметры.СерийныйНомер   = СсылкаНаОбъект.СерийныйНомер;
	ОблШапка.Параметры.ДатаНомерДок    = СсылкаНаОбъект.НомерДокОтгрузки;
	ОблШапка.Параметры.КонечныйКлиент  = ОбщегоНазначения.ЗаменитьНаТранслит(СсылкаНаОбъект.КонечныйПользователь);
	ОблШапка.Параметры.Трактор         = СсылкаНаОбъект.Трактор;
	ОблШапка.Параметры.ДатаПоставки    = Формат(СсылкаНаОбъект.ДатаОтгрузки, "ДФ=dd.MM.yyyy");
	ОблШапка.Параметры.ДатаПоломки     = Формат(СсылкаНаОбъект.ДатаПоломки, "ДФ=dd.MM.yyyy");
	ОблШапка.Параметры.КоличествоГА    = СсылкаНаОбъект.КоличествоГА;
	ОблШапка.Параметры.Неисправность   = СсылкаНаОбъект.НеисправностьОписание;
	
	Если СсылкаНаОбъект.ВидЗапроса = Перечисления._ВидыГарантийныхЗапросов.Недопоставка Тогда 
		ОблШапка.Параметры.ВидДокумента = "Missing parts request - Заявка на недопоставку";	
	Иначе
		ОблШапка.Параметры.ВидДокумента = "Warranty сlaim - Гарантийная заявка";  
	КонецЕсли;
	
	Если ЗначениеЗаполнено(СсылкаНаОбъект.ЗаказПоставщику) Тогда 
		ОблШапка.Параметры.НомерЗаказа = СокрЛП(СсылкаНаОбъект.ЗаказПоставщику.Номер);	
	КонецЕсли;
	
	ТабДок.Вывести(ОблШапка);
	
	сч = 0;
	счСтрок = 0;
	Для Каждого Строка Из СсылкаНаОбъект.Товары Цикл
		
		счСтрок = счСтрок + 1;
		Если счСтрок = 9 Тогда 
			счСтрок = 0;
			ТабДок.Вывести(ОблПодвал);
			ТабДок.ВывестиГоризонтальныйРазделительСтраниц();
			ТабДок.Вывести(ОблШапка);
		КонецЕсли;
		
		сч = сч + 1;
		ОблСтрока.Параметры.Номер = сч;
		ОблСтрока.Параметры.Причина = Строка.ПричинаНеисправности;
		Если ЗначениеЗаполнено(Строка.Номенклатура) Тогда 
			ОблСтрока.Параметры.Код = Строка.Номенклатура.Код;
			ОблСтрока.Параметры.Наименование = Строка.Номенклатура.Наименование;
		Иначе
			ОблСтрока.Параметры.Код = "";
			ОблСтрока.Параметры.Наименование = Строка.ВнешнийКод;
		КонецЕсли;
		
		ОблСтрока.Параметры.Количество = Строка.Количество;
		
		ТабДок.Вывести(ОблСтрока);
		
	КонецЦикла;
	
	ОблПодвал.Параметры.Дата = Формат(СсылкаНаОбъект.Дата, "ДФ=dd.MM.yyyy");
	
	ТабДок.Вывести(ОблПодвал);
	
	ТабДок.АвтоМасштаб         = Истина;
	ТабДок.ОтображатьЗаголовки = Истина;
	ТабДок.ОтображатьСетку     = Ложь;
	
	Возврат ТабДок;
	
КонецФункции

&НаСервере
Функция   ПечатнаяФорма(ПараметрКоманды) Экспорт
	
	Отказ = Ложь;
	
	//Если ПараметрКоманды.Проведен Тогда 
		ТабДок = Печать(ПараметрКоманды);	
	//Иначе
	//	Сообщение = Новый СообщениеПользователю;
	//	Сообщение.Текст = "Невозможно распечатать непроведенный документ. " + Символы.ПС + "Проведите документ и повторите попытку";
	//	Сообщение.Сообщить();
	//	Возврат Неопределено
	//КонецЕсли;
	
	Возврат ТабДок;
	
КонецФункции

&НаСервере
Функция   ПолучитьРеквНаСервере(ИмяРекв, Ссылка)
	
	Если       ИмяРекв = "Контр" Тогда
		Наименование = Ссылка.Дилер.НаименованиеПолное;
		Возврат СтрЗаменить(Наименование, Символ(34), "");
	ИначеЕсли  ИмяРекв = "Номер" Тогда
		Возврат СокрЛП(Ссылка.Номер);
	ИначеЕсли  ИмяРекв = "Дата" Тогда 
		Возврат Формат(Ссылка.Дата, "ДФ=dd.MM.yyyy");	
	КонецЕсли;
	
КонецФункции

&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	
	ТабличныйДокумент = ПечатнаяФорма(ПараметрКоманды);
	
	Если НЕ ТабличныйДокумент = Неопределено Тогда
		Контр = ПолучитьРеквНаСервере("Контр", ПараметрКоманды);
		Номер = ПолучитьРеквНаСервере("Номер", ПараметрКоманды);
		Дата  = ПолучитьРеквНаСервере("Дата", ПараметрКоманды);
		ТабличныйДокумент.Показать("Warranty request " + Контр + " №" + Номер + " from " + Дата);
	КонецЕсли;	
	
КонецПроцедуры

