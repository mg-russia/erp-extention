
&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	
	ОставитьНаСкладе = Ложь;
	Если Вопрос("Оставить шины на складе?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Да Тогда 
		ОставитьНаСкладе = Истина;
	КонецЕсли;
	
	Рез = СписатьСоСкладаСервер(ПараметрКоманды, ОставитьНаСкладе);
	Если Рез.Свойство("Док") Тогда 
		Предупреждение("Создан докмент списания: " + Рез.Док);
	Иначе
		Предупреждение("Не удалось создать докмент списания. Причина: " + Рез.Сообщение);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция   СписатьСоСкладаСервер(Шина, ОставитьНаСкладе)
	
	Если ТекущаяДата() < '20140601' Тогда 
		
		Док = Документы._РемонтныйЛист.СоздатьДокумент();
		Док.ВидРемонтаТС = Перечисления._ВидРемонтаТС.ПереоборудованиеШин;
		Док.Ответственный = глЗначениеПеременной("глТекущийПользователь");
		Док.Дата = ТекущаяДата();
		
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		|	ЕСТЬNULL(_ОстаткиШинОстатки.КоличествоОстаток, 0) КАК Количество,
		|	_ОстаткиШинОстатки.Шина,
		|	_ОстаткиШинОстатки.ТС,
		|	_ОстаткиШинОстатки.МестоУстановки
		|ИЗ
		|	РегистрНакопления._ОстаткиШин.Остатки(, Шина = &Шина) КАК _ОстаткиШинОстатки";
		
		Запрос.УстановитьПараметр("Шина", Шина);
		
		сч = 0;
		Результат = Запрос.Выполнить();
		Выборка = Результат.Выбрать();
		Пока Выборка.Следующий() Цикл
			
			Если сч = 0 Тогда 
				сч = 1;
				Док.ТС = Выборка.ТС;
			Иначе
				Если Не Выборка.ТС = Док.ТС Тогда //одна шина на нескольких ТС, такого быть не должно
					Прервать;	
				КонецЕсли;
			КонецЕсли;
			
			Новая = Док.Шины.Добавить();
			ЗаполнитьЗначенияСвойств(Новая, Выборка);
			Новая.СобытиеСШиной = Перечисления._СобытиеСШиной.Снята;
			
			Если ОставитьНаСкладе Тогда 
				Если ЗначениеЗаполнено(Новая.ТС) Тогда //шина была на ТС и была списана
					Новая = Док.Шины.Добавить();
					ЗаполнитьЗначенияСвойств(Новая, Выборка);
					Новая.СобытиеСШиной = Перечисления._СобытиеСШиной.Установлена;
					Новая.ТС = Неопределено;
				КонецЕсли;
			КонецЕсли;
			
		КонецЦикла;
		
		Если Док.Шины.Количество() > 0 Тогда 
			Док.Записать(РежимЗаписиДокумента.Проведение);
			Возврат Строка(Док.Ссылка);
		КонецЕсли;
		
		Возврат Неопределено;
		
	Иначе
		
		Док = Документы._РемонтныйЛист.СоздатьДокумент();
		Док.ВидРемонтаТС = Перечисления._ВидРемонтаТС.ПереоборудованиеШин;
		Док.Ответственный = глЗначениеПеременной("глТекущийПользователь");
		Док.Дата = ТекущаяДата();
		
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		|	_УстановленныеШиныСрезПоследних.Шина,
		|	_УстановленныеШиныСрезПоследних.ТС,
		|	_УстановленныеШиныСрезПоследних.МестоУстановки
		|ИЗ
		|	РегистрСведений._УстановленныеШины.СрезПоследних(, ) КАК _УстановленныеШиныСрезПоследних
		|ГДЕ
		|	_УстановленныеШиныСрезПоследних.Шина = &Шина
		|	И _УстановленныеШиныСрезПоследних.ТС = &ТС";
		
		//Делается срез, а затем действует условие_УстановленныеШиныСрезПоследних.Шина = &Шина И _УстановленныеШиныСрезПоследних.ТС = &ТС  
		
		Запрос.УстановитьПараметр("Шина", Шина);
		Запрос.УстановитьПараметр("ТС", _Кирилл.ПолучитьЗначениеПараметра("ОсновнойСклад"));
		
		сч = 0;
		Результат = Запрос.Выполнить();
		Выборка = Результат.Выбрать();
		Пока Выборка.Следующий() Цикл
			
			Если сч = 0 Тогда 
				сч = 1;
				Док.ТС = Выборка.ТС;
			Иначе
				Если Не Выборка.ТС = Док.ТС Тогда //одна шина на нескольких ТС, такого быть не должно
					Прервать;	
				КонецЕсли;
			КонецЕсли;
			
			Новая = Док.Шины.Добавить();
			ЗаполнитьЗначенияСвойств(Новая, Выборка);
			Новая.СобытиеСШиной = Перечисления._СобытиеСШиной.Установлена;
			
			Если ОставитьНаСкладе Тогда
				Если Выборка.ТС = _Кирилл.ПолучитьЗначениеПараметра("ОсновнойСклад") Тогда 
					Возврат Новый Структура("Сообщение", "Шина уже находится на складе");
				Иначе
					Новая.ТС = _Кирилл.ПолучитьЗначениеПараметра("ОсновнойСклад");
				КонецЕсли;
			Иначе
				Новая.ТС = Неопределено;
			КонецЕсли;
			
		КонецЦикла;
		
		Если Док.Шины.Количество() > 0 Тогда 
			Док.Комментарий = "Списание шины со склада";
			Док.Записать(РежимЗаписиДокумента.Проведение);
			Возврат Новый Структура("Док", Строка(Док.Ссылка));
		КонецЕсли;
		
		Возврат Новый Структура("Сообщение", "Ошибка при списании");
		
	КонецЕсли;
	
КонецФункции
