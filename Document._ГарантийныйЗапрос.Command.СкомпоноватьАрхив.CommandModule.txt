
&НаСервере
Функция   Печать(СсылкаНаОбъект) Экспорт
	
	ТабДок = Новый ТабличныйДокумент;
	Макет = Документы._ГарантийныйЗапрос.ПолучитьМакет("ГарантийныйЗапрос");
	
	ОблШапка  = Макет.ПолучитьОбласть("Шапка");
	ОблСтрока = Макет.ПолучитьОбласть("Строка");
	ОблПодвал = Макет.ПолучитьОбласть("Подвал");
	
	ОблШапка.Параметры.Номер           = СокрЛП(СсылкаНаОбъект.Номер);
	ОблШапка.Параметры.Дата            = Формат(СсылкаНаОбъект.Дата, "ДФ=dd.MM.yyyy");
	Если ЗначениеЗаполнено(СсылкаНаОбъект.Дилер) Тогда 
		ОблШапка.Параметры.Дилер       = СсылкаНаОбъект.Дилер.НаименованиеПолное;
	КонецЕсли;
	ОблШапка.Параметры.Модель          = СсылкаНаОбъект.МодельМашины;
	ОблШапка.Параметры.СерийныйНомер   = СсылкаНаОбъект.СерийныйНомер;
	ОблШапка.Параметры.ДатаНомерДок    = СсылкаНаОбъект.НомерДокОтгрузки;
	ОблШапка.Параметры.КонечныйКлиент  = СсылкаНаОбъект.КонечныйПользователь;
	ОблШапка.Параметры.Трактор         = СсылкаНаОбъект.Трактор;
	ОблШапка.Параметры.ДатаПоставки    = Формат(СсылкаНаОбъект.ДатаОтгрузки, "ДФ=dd.MM.yyyy");
	ОблШапка.Параметры.ДатаПоломки     = Формат(СсылкаНаОбъект.ДатаПоломки, "ДФ=dd.MM.yyyy");
	ОблШапка.Параметры.КоличествоГА    = СсылкаНаОбъект.КоличествоГА;
	ОблШапка.Параметры.Неисправность   = СсылкаНаОбъект.НеисправностьОписание;
	
	Если СсылкаНаОбъект.ВидЗапроса = Перечисления._ВидыГарантийныхЗапросов.Недопоставка Тогда 
		ОблШапка.Параметры.ВидДокумента = "Missing parts request - Заявка на недопоставку";	
	Иначе
		ОблШапка.Параметры.ВидДокумента = "Warranty сlaim - Гарантийная заявка";  
	КонецЕсли;
	
	Если ЗначениеЗаполнено(СсылкаНаОбъект.ЗаказПоставщику) Тогда 
		ОблШапка.Параметры.НомерЗаказа = СокрЛП(СсылкаНаОбъект.ЗаказПоставщику.Номер);	
	КонецЕсли;
	
	ТабДок.Вывести(ОблШапка);
	
	сч = 0;
	счСтрок = 0;
	Для Каждого Строка Из СсылкаНаОбъект.Товары Цикл
		
		счСтрок = счСтрок + 1;
		Если счСтрок = 9 Тогда 
			счСтрок = 0;
			ТабДок.Вывести(ОблПодвал);
			ТабДок.ВывестиГоризонтальныйРазделительСтраниц();
			ТабДок.Вывести(ОблШапка);
		КонецЕсли;
		
		сч = сч + 1;
		ОблСтрока.Параметры.Номер = сч;
		ОблСтрока.Параметры.Причина = Строка.ПричинаНеисправности;
		Если ЗначениеЗаполнено(Строка.Номенклатура) Тогда 
			ОблСтрока.Параметры.Код = Строка.Номенклатура.Код;
			ОблСтрока.Параметры.Наименование = Строка.Номенклатура.Наименование;
		Иначе
			ОблСтрока.Параметры.Код = "";
			ОблСтрока.Параметры.Наименование = Строка.ВнешнийКод;
		КонецЕсли;
		
		ОблСтрока.Параметры.Количество = Строка.Количество;
		
		ТабДок.Вывести(ОблСтрока);
		
	КонецЦикла;
	
	ОблПодвал.Параметры.Дата = Формат(СсылкаНаОбъект.Дата, "ДФ=dd.MM.yyyy");
	
	ТабДок.Вывести(ОблПодвал);
	
	ТабДок.АвтоМасштаб         = Истина;
	ТабДок.ОтображатьЗаголовки = Истина;
	ТабДок.ОтображатьСетку     = Ложь;
	
	Возврат ТабДок;
	
КонецФункции

&НаСервере
Процедура СкомпоноватьРезультатСервер(СсылкаНаОбъект)
	
	МассивВложений = Новый Массив;
	
	ИмяВремФайла = ПолучитьИмяВременногоФайла(".xls");
	Путь         = "\\Wan-russ2\RUS_DatiALL\MG-Russia\All users\1C service data\WC\";
	Ид           = СсылкаНаОбъект.УникальныйИдентификатор();
	
	сч = 0;
	Для Каждого Строка Из СсылкаНаОбъект.Файлы Цикл  
		сч = сч + 1;
		Если ЗначениеЗаполнено(Строка.Расширение) Тогда 
			Если Строка.ВключатьВПисьмо Тогда 
				Попытка
					ПутьФайла = Путь + ИД + сч + Строка.Расширение;
					МассивВложений.Добавить(ПутьФайла);
				Исключение
				КонецПопытки;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	ТабДок = Печать(СсылкаНаОбъект);
	ТабДок.Записать(ИмяВремФайла, ТипФайлаТабличногоДокумента.XLS);

	Адрес = _Кирилл.ПолучитьАдресЭлектроннойПочтыПользователя(глЗначениеПеременной("глТекущийПользователь"));	
	
	Если Не ПустаяСтрока(Адрес) Тогда 
		
		МассивВложений.Добавить(ИмяВремФайла);
		
		СтруктураПараметров  = Новый Структура;
		СтруктураПараметров.Вставить("Кому"     , Адрес);
		СтруктураПараметров.Вставить("Тема"     , "Files pack for WC № " + ОбщегоНазначения.ПолучитьНомерНаПечать(СсылкаНаОбъект) + " from " + Формат(СсылкаНаОбъект.Дата, "ДФ=dd.MM.yyyy"));
		СтруктураПараметров.Вставить("Текст"    , "");
		СтруктураПараметров.Вставить("Вложение" , МассивВложений);
		
		ОбщегоНазначения.ОтправитьПисьмо(СтруктураПараметров);
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Письмо отправлено на ваш электронный адрес: " + Адрес;
		Сообщение.Сообщить();
		
	Иначе
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Не задан электронный адрес пользователя. Отправка письма невозможна";
		Сообщение.Сообщить();
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	
	СкомпоноватьРезультатСервер(ПараметрКоманды);
	
КонецПроцедуры
